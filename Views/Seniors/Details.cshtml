@model VivuqeQRSystem.Models.Senior

<div class="row g-4">
    @if (TempData["GuestLimit"] != null)
    {
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>@TempData["GuestLimit"]
            </div>
        </div>
    }
    
    @if (TempData["GuestEditError"] != null)
    {
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>@TempData["GuestEditError"]
            </div>
        </div>
    }
    
    <div class="col-12 col-lg-4">
        <div class="card vivuqe-card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-user-graduate fa-4x text-primary"></i>
                </div>
                <h4 class="card-title">@Model.Name</h4>
                <p class="text-white-50 mb-1">
                    <i class="fas fa-users me-1"></i>Guests allowed: @Model.NumberOfGuests
                </p>
                @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                {
                    <p class="text-white-50 mb-3">
                        <i class="fas fa-phone me-1"></i>@Model.PhoneNumber
                    </p>
                }
                else
                {
                    <div class="mb-3"></div>
                }
                
                <div class="mb-4">
                    <div class="vivuqe-qr">
                        <img class="img-fluid" alt="QR Code" src="@Url.Action("QrImage", new { id = Model.SeniorId })" />
                    </div>
                </div>
                
                <div class="small text-break mb-3">
                    <a href="@Model.QrUrl" target="_blank" class="text-decoration-none">
                        <i class="fas fa-external-link-alt me-1"></i>@Model.QrUrl
                    </a>
                </div>
                
                <div class="d-grid gap-2 mb-3">
                    <a class="btn btn-outline-light btn-sm" href="@Url.Action("QrImage", new { id = Model.SeniorId })" download>
                        <i class="fas fa-download me-1"></i>Download QR
                    </a>
                    <a class="btn btn-success btn-sm" href="@Url.Action("ShareInvitations", new { id = Model.SeniorId })">
                        <i class="fab fa-whatsapp me-1"></i>Share Invitations
                    </a>
                </div>
                
                <div class="d-grid gap-2">
                    @if (Model.EventId != null)
                    {
                        <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("Details", "Events", new { id = Model.EventId })">
                            <i class="fas fa-arrow-left me-1"></i>Back to Event
                        </a>
                    }
                    else
                    {
                        <a class="btn btn-outline-secondary btn-sm" href="@Url.Action("Index", "Events")">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </a>
                    }
                    @if (User.IsInRole("Admin"))
                    {
                    <a class="btn btn-primary btn-sm" href="@Url.Action("Edit", new { id = Model.SeniorId })">
                        <i class="fas fa-edit me-1"></i>Edit Senior
                    </a>
                    <form asp-action="Delete" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this senior?');">
                        <input type="hidden" name="id" value="@Model.SeniorId" />
                        <button type="submit" class="btn btn-danger btn-sm w-100">
                            <i class="fas fa-trash me-1"></i>Delete Senior
                        </button>
                    </form>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-lg-8">
        <div class="card vivuqe-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Guests Management
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user"></i><span class="d-none d-sm-inline ms-1">Name</span></th>
                                <th><i class="fas fa-phone"></i><span class="d-none d-sm-inline ms-1">Phone</span></th>
                                <th><i class="fas fa-check-circle"></i><span class="d-none d-sm-inline ms-1">Status</span></th>
                                <th class="d-none d-md-table-cell"><i class="fas fa-clock"></i><span class="ms-1">Time</span></th>
                                <th><i class="fas fa-cogs"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var g in Model.Guests)
                        {
                            <tr data-guest-id="@g.GuestId">
                                <td>
                                    <i class="fas fa-user me-2"></i>@g.Name
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(g.PhoneNumber))
                                    {
                                        <span style="color: #ffffff; background: #352e9aff; border: 2px solid #8B5CF6; padding: 5px 12px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; display: inline-block;">@g.PhoneNumber</span>
                                    }
                                    else
                                    {
                                        <span class="text-white-50">-</span>
                                    }
                                </td>
                                <td>
                                    @if (g.IsAttended)
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Attended
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    }
                                </td>
                                <td class="d-none d-md-table-cell">
                                    @if (g.IsAttended)
                                    {
                                        <i class="fas fa-calendar-check me-1"></i>@g.AttendanceTime?.ToLocalTime().ToString("g")
                                    }
                                    else
                                    {
                                        <span class="text-white-50">-</span>
                                    }
                                </td>
                                <td class="text-end">
                                    @if (!g.IsAttended)
                                    {
                                        @if (!User.IsInRole("Senior"))
                                        {
                                        <form asp-action="MarkAttendance" method="post" class="d-inline">
                                            <input type="hidden" name="guestId" value="@g.GuestId" />
                                            <button type="submit" class="btn btn-sm btn-success" title="Mark Attended">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        }
                                        @if (User.IsInRole("Admin"))
                                        {
                                        <button class="btn btn-sm btn-warning" type="button" data-bs-toggle="collapse" data-bs-target="#editGuest-@g.GuestId" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form asp-action="DeleteGuest" method="post" class="d-inline" onsubmit="return confirm('Delete this guest?');">
                                            <input type="hidden" name="id" value="@g.GuestId" />
                                            <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        }
                                    }
                                    else
                                    {
                                        @if (!User.IsInRole("Senior"))
                                        {
                                        <form asp-action="UnmarkAttendance" method="post" class="d-inline">
                                            <input type="hidden" name="guestId" value="@g.GuestId" />
                                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Unmark">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </form>
                                        }
                                    }
                                </td>
                            </tr>
                            <tr class="collapse" id="editGuest-@g.GuestId">
                                <td colspan="5">
                                    <div class="card vivuqe-card">
                                        <div class="card-body">
                                            <form asp-action="EditGuest" method="post" class="row g-2 align-items-center">
                                                <input type="hidden" name="id" value="@g.GuestId" />
                                                <div class="col-12 col-md-4">
                                                    <input name="name" value="@g.Name" class="form-control" placeholder="Guest name" />
                                                </div>
                                                <div class="col-12 col-md-4">
                                                    <input name="phoneNumber" value="@g.PhoneNumber" class="form-control" placeholder="Phone (opt)" />
                                                </div>
                                                <div class="col-12 col-md-4 d-grid d-md-block">
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-save me-1"></i>Save
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                
                @if (!Model.Guests.Any())
                {
                    <div class="text-center py-4">
                        <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                        <h6 class="text-white-50">No guests added yet</h6>
                        <p class="text-white-50">Add guests using the form below.</p>
                    </div>
                }
                
                <hr />
                
                @if (User.IsInRole("Admin"))
                {
                <div class="card vivuqe-card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-plus me-2"></i>Add New Guest
                        </h6>
                    </div>
                    <div class="card-body">
                        <form asp-action="AddGuest" method="post" class="row g-2">
                            <input type="hidden" name="seniorId" value="@Model.SeniorId" />
                            <div class="col-12 col-md-4">
                                <input name="name" class="form-control" placeholder="Enter guest name" />
                            </div>
                            <div class="col-12 col-md-4">
                                <input name="phoneNumber" class="form-control" placeholder="Phone (optional)" />
                            </div>
                            <div class="col-12 col-md-4 d-grid d-md-block">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>Add Guest
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Highlight guest from search AND Auto-Mark Attendance
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const highlightGuestId = urlParams.get('highlightGuest');
            
            if (highlightGuestId) {
                const guestRow = document.querySelector(`tr[data-guest-id="${highlightGuestId}"]`);
                if (guestRow) {
                    // 1. Add highlight class
                    guestRow.classList.add('guest-highlight');
                    
                    // 2. Scroll to the guest row
                    setTimeout(() => {
                        guestRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                    
                    // 3. Auto-Mark Attendance (ONLY if autoMark=true is present)
                    const autoMark = urlParams.get('autoMark');
                    const markForm = guestRow.querySelector('form[action$="MarkAttendance"]');
                    if (markForm && autoMark === 'true') {
                        // Optional: Confirm before auto-marking or just do it?
                        // Let's do it immediately for speed, maybe add a visual indicator
                        console.log("Auto-marking attendance for guest " + highlightGuestId);
                        
                        // Submit the form
                        markForm.submit();
                    }

                    // Remove highlight after 5 seconds (only if page doesn't reload, but form submit reloads usually)
                    setTimeout(() => {
                        guestRow.classList.remove('guest-highlight');
                    }, 5000);
                }
            }
        });
    </script>
}
