@model VivuqeQRSystem.Models.Senior

@{
    ViewData["Title"] = "Share Invitations - " + Model.Name;
    
    var eventDate = Model.Event?.Date.ToString("dd-MM-yyyy") ?? "11-12-2025";
    var eventLocation = Model.Event?.Location ?? "New Life â€“ Ø§Ù„ÙˆØ§Ø³Ø·ÙŠ";
    var eventName = Model.Event?.Name ?? "25 Jun School Fun Day";
    var inviteLink = "https://stageup-qr.fly.dev/25JunSchoolFunDay";
}

<div class="row g-4">
    <div class="col-12">
        <div class="card vivuqe-card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <h4 class="mb-1">
                        <i class="fas fa-share-alt text-success me-2"></i>Share Invitations
                    </h4>
                    <p class="text-white-50 mb-0">
                        <i class="fas fa-user-graduate me-1"></i>@Model.Name â€¢ 
                        <span class="badge bg-primary">@Model.Guests.Count Guests</span>
                    </p>
                </div>
                <a asp-action="Details" asp-route-id="@Model.SeniorId" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Back to Details
                </a>
            </div>
            <div class="card-body">
                <!-- Instructions -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>How to use:</h6>
                    <ol class="mb-0 ps-3">
                        <li>Click the <strong>WhatsApp</strong> button next to each guest</li>
                        <li>It will open WhatsApp with the invitation message ready</li>
                        <li>Just press <strong>Send</strong> in WhatsApp!</li>
                    </ol>
                </div>

                <!-- Guest List with Share Buttons -->
                <div class="list-group" id="guestList">
                    @foreach (var guest in Model.Guests)
                    {
                        var guestPhone = guest.PhoneNumber?.Replace(" ", "").Replace("-", "").Replace("+", "") ?? "";
                        if (guestPhone.StartsWith("0"))
                        {
                            guestPhone = "2" + guestPhone; // Egypt: 0xxx -> 20xxx
                        }
                        
                        <div class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div>
                                <i class="fas fa-user me-2 text-primary"></i>
                                <strong class="guest-name">@guest.Name</strong>
                                @if (!string.IsNullOrEmpty(guest.PhoneNumber))
                                {
                                    <span class="badge bg-secondary ms-2 guest-phone" data-phone="@guestPhone">@guest.PhoneNumber</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark ms-2"><i class="fas fa-exclamation-triangle me-1"></i>No Phone</span>
                                    <span class="guest-phone d-none" data-phone=""></span>
                                }
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm whatsapp-btn" 
                                        data-name="@guest.Name" 
                                        data-phone="@guestPhone"
                                        data-ticket-token="@guest.TicketToken">
                                    <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                </button>
                                <button class="btn btn-outline-light btn-sm copy-btn" data-name="@guest.Name" title="Copy Message">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>

                @if (!Model.Guests.Any())
                {
                    <div class="text-center py-5">
                        <i class="fas fa-users-slash fa-4x text-white-50 mb-3"></i>
                        <h5 class="text-white-50">No Guests Found</h5>
                        <p class="text-white-50">Add guests first to share invitations.</p>
                        <a asp-action="Details" asp-route-id="@Model.SeniorId" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Add Guests
                        </a>
                    </div>
                }

                <!-- Share All Section -->
                @if (Model.Guests.Any())
                {
                    <hr class="my-4" />
                    <div class="text-center">
                        <p class="text-white-50 mb-3">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            Total: <strong>@Model.Guests.Count</strong> guests to invite
                        </p>
                        <button id="copyAllBtn" class="btn btn-outline-primary">
                            <i class="fas fa-clipboard-list me-1"></i>Copy All Phone Numbers
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Event details for the message
        const eventName = '@Html.Raw(eventName.Replace("'", "\\'"))';
        const eventDate = '@eventDate';
        const eventLocation = '@Html.Raw(eventLocation.Replace("'", "\\'"))';
        // Base URL for ticket links
        const baseUrl = window.location.origin;
        
        // Build the invitation message with emojis
        function buildMessage(guestName, ticketToken) {
            // Personalized Ticket Link
            const ticketLink = `${baseUrl}/Ticket/${ticketToken}`;

            return `Hi ${guestName}! âœ¨
Youâ€™re exclusively invited to the SMS Fun Day

ðŸ“… 14â€“12â€“2025 (14 Dec 2025)
â° 6:00 PM (Doors close 9:00 PM)
ðŸ“ Nile House

Open your personalized invitation & location details:
ðŸ‘‰ ${ticketLink}

See you there. ðŸ’™`;
        }

        // WhatsApp button click
        document.querySelectorAll('.whatsapp-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const name = this.getAttribute('data-name');
                const phone = this.getAttribute('data-phone');
                const ticketToken = this.getAttribute('data-ticket-token');
                
                const message = buildMessage(name, ticketToken);
                const encodedMessage = encodeURIComponent(message);
                
                let whatsappUrl;
                if (phone) {
                    whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                }
                
                window.open(whatsappUrl, '_blank');
            });
        });

        // Copy single message
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const name = this.getAttribute('data-name');
                const message = buildMessage(name);
                navigator.clipboard.writeText(message).then(() => {
                    const icon = this.querySelector('i');
                    icon.className = 'fas fa-check text-success';
                    setTimeout(() => {
                        icon.className = 'fas fa-copy';
                    }, 2000);
                });
            });
        });

        // Copy all phone numbers
        document.getElementById('copyAllBtn')?.addEventListener('click', function() {
            const phones = [];
            document.querySelectorAll('.guest-phone').forEach(el => {
                const phone = el.getAttribute('data-phone');
                if (phone) phones.push(phone);
            });
            navigator.clipboard.writeText(phones.join('\n')).then(() => {
                this.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-clipboard-list me-1"></i>Copy All Phone Numbers';
                }, 2000);
            });
        });
    </script>
}
